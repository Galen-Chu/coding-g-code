# CI/CD Toolkit - GitHub Actions CI Workflow
# =============================================================================
# Continuous Integration pipeline with linting, testing, and coverage.
#
# Triggers:
#   - Push to main, develop branches
#   - Pull requests to main
#   - Manual workflow dispatch

name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  GO_VERSION: '1.21'

jobs:
  # =============================================================================
  # Lint Job
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup toolkit
        run: |
          chmod +x scripts/ci/lint.sh
          chmod +x scripts/utils/common.sh
          chmod +x scripts/utils/logger.sh
          chmod +x scripts/utils/validators.sh

      - name: Run linting
        run: bash scripts/ci/lint.sh
        env:
          LOG_LEVEL: info

  # =============================================================================
  # CHANGELOG Check Job
  # =============================================================================
  changelog:
    name: CHANGELOG Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup toolkit
        run: |
          chmod +x scripts/utils/update-changelog.sh
          chmod +x scripts/utils/common.sh
          chmod +x scripts/utils/logger.sh

      - name: Check CHANGELOG was updated
        run: |
          # Get the base branch
          BASE_BRANCH="${{ github.base_ref }}"
          if [ -z "$BASE_BRANCH" ]; then
            BASE_BRANCH="main"
          fi

          echo "Checking against base branch: $BASE_BRANCH"

          # Check if CHANGELOG.md was modified
          if git diff --name-only origin/"$BASE_BRANCH"...HEAD | grep -q "^CHANGELOG.md$"; then
            echo "âœ“ CHANGELOG.md has been updated"
            exit 0
          fi

          # Check if commit type requires CHANGELOG
          COMMIT_TYPE=$(git log --format=%s --reverse origin/"$BASE_BRANCH"...HEAD | head -1 | cut -d':' -f1)

          case "$COMMIT_TYPE" in
            feat*|fix*|perf*|revert*)
              echo "âŒ CHANGELOG.md not updated for commit type: $COMMIT_TYPE"
              echo ""
              echo "Please update CHANGELOG.md to document these changes."
              echo ""
              echo "Quick update:"
              echo "  bash scripts/utils/update-changelog.sh"
              echo ""
              exit 1
              ;;
            *)
              echo "âœ“ CHANGELOG update not required for: $COMMIT_TYPE"
              exit 0
              ;;
          esac

      - name: Validate CHANGELOG format
        run: bash scripts/utils/update-changelog.sh --validate
        continue-on-error: false

  # =============================================================================
  # Test Job
  # =============================================================================
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        # Project-specific versions - adjust as needed
        node-version: ['18', '20']
        # python-version: ['3.10', '3.11', '3.12']
        # go-version: ['1.20', '1.21']
    exclude:
      # Exclude combinations that don't make sense
      - os: windows-latest
        node-version: '18'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # Uncomment for Python projects
      # - name: Setup Python ${{ matrix.python-version }}
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: ${{ matrix.python-version }}
      #     cache: 'pip'

      # Uncomment for Go projects
      # - name: Setup Go ${{ matrix.go-version }}
      #   uses: actions/setup-go@v5
      #   with:
      #     go-version: ${{ matrix.go-version }}
      #     cache: true

      - name: Setup toolkit
        run: |
          chmod +x scripts/ci/test.sh
          chmod +x scripts/utils/common.sh
          chmod +x scripts/utils/logger.sh
          chmod +x scripts/utils/validators.sh

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            pip install -e .
          fi
        shell: bash

      - name: Run tests
        run: bash scripts/ci/test.sh --coverage
        env:
          LOG_LEVEL: info

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.node-version }}
          path: test-results/
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info,./coverage/cobertura-coverage.xml
          flags: unittests
          name: codecov-${{ matrix.os }}-${{ matrix.node-version }}
          fail_ci_if_error: false

  # =============================================================================
  # Coverage Job
  # =============================================================================
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup toolkit
        run: |
          chmod +x scripts/ci/coverage.sh
          chmod +x scripts/utils/common.sh
          chmod +x scripts/utils/logger.sh
          chmod +x scripts/utils/validators.sh

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage
        run: bash scripts/ci/coverage.sh --format lcov
        env:
          COVERAGE_THRESHOLD: 80

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

      - name: Coverage comment
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: github.event_name == 'pull_request'
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Security Scan Job
  # =============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Run npm audit for Node.js projects
      - name: Run npm audit
        if: hashFiles('package.json') != ''
        run: npm audit --audit-level=moderate
        continue-on-error: true

      # Run safety check for Python projects
      - name: Run safety check
        if: hashFiles('requirements.txt', 'pyproject.toml') != ''
        run: |
          pip install safety
          safety check --json > safety-report.json || true
        continue-on-error: true

      # Run Snyk security scan
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      # Upload security reports
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            safety-report.json
            snyk-report.json
          retention-days: 30

  # =============================================================================
  # Build Check Job
  # =============================================================================
  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup toolkit
        run: |
          chmod +x scripts/cd/build.sh
          chmod +x scripts/utils/common.sh
          chmod +x scripts/utils/logger.sh

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: bash scripts/cd/build.sh --output dist
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # =============================================================================
  # Summary Job
  # =============================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, coverage, build-check]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.build-check.result }}" != "success" ]]; then
            echo "::error::One or more jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts/

      - name: Generate summary
        run: |
          echo "## CI Pipeline Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage**: ${{ needs.coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -R all-artifacts/ | head -20 >> $GITHUB_STEP_SUMMARY
